# Ultralytics YOLO ğŸš€, AGPL-3.0 license
# YOLOv8n_Ultimate_Complete - SimAM + BiFPN + QFL å®Œæ•´ç»„åˆ
# çœŸæ­£çš„BiFPNå®ç°ï¼ŒåŒ…å«åŠ æƒç‰¹å¾èåˆå’Œå¤šè½®åŒå‘èåˆ

# Parameters
nc: 4  # ç±»åˆ«æ•°: black_rot, blight, black_measles, Healthy
scales:  # model compound scaling constants
  # [depth, width, max_channels]
  n: [0.33, 0.25, 1024]  # YOLOv8n

# YOLOv8n backbone
backbone:
  # [from, repeats, module, args]
  - [-1, 1, Conv, [64, 3, 2]]  # 0-P1/2
  - [-1, 1, Conv, [128, 3, 2]]  # 1-P2/4
  - [-1, 3, C2f, [128, True]]  # 2
  - [-1, 1, Conv, [256, 3, 2]]  # 3-P3/8
  - [-1, 6, C2f, [256, True]]  # 4
  - [-1, 1, Conv, [512, 3, 2]]  # 5-P4/16
  - [-1, 6, C2f, [512, True]]  # 6
  - [-1, 1, Conv, [1024, 3, 2]]  # 7-P5/32
  - [-1, 3, C2f, [1024, True]]  # 8
  - [-1, 1, SPPF, [1024, 5]]  # 9
  - [-1, 1, SimAM, []]  # 10 - â­ SimAMæ³¨æ„åŠ›

# YOLOv8n head with BiFPN structure
head:
  # ==================== ç¬¬ä¸€è½® BiFPN èåˆ ====================
  # Top-down path (ç¬¬ä¸€æ¬¡è‡ªé¡¶å‘ä¸‹)
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]  # 11: P5 -> ä¸Šé‡‡æ ·
  - [[-1, 6], 1, Concat, [1]]  # 12: ä¸ P4 è¿æ¥
  - [-1, 3, C2f, [512]]  # 13: èåˆ P4+P5

  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]  # 14: P4 -> ä¸Šé‡‡æ ·
  - [[-1, 4], 1, Concat, [1]]  # 15: ä¸ P3 è¿æ¥
  - [-1, 3, C2f, [256]]  # 16: èåˆ P3+P4

  # Bottom-up path (ç¬¬ä¸€æ¬¡è‡ªåº•å‘ä¸Š)
  - [-1, 1, Conv, [256, 3, 2]]  # 17: P3 -> ä¸‹é‡‡æ ·
  - [[-1, 13], 1, Concat, [1]]  # 18: ä¸èåˆåçš„ P4 è¿æ¥
  - [-1, 3, C2f, [512]]  # 19: ç¬¬äºŒæ¬¡èåˆ P4

  - [-1, 1, Conv, [512, 3, 2]]  # 20: P4 -> ä¸‹é‡‡æ ·
  - [[-1, 10], 1, Concat, [1]]  # 21: ä¸ SimAM åçš„ P5 è¿æ¥
  - [-1, 3, C2f, [1024]]  # 22: ç¬¬äºŒæ¬¡èåˆ P5

  # ==================== ç¬¬äºŒè½® BiFPN èåˆï¼ˆå¢å¼ºç‰ˆï¼‰====================
  # è¿™æ˜¯çœŸæ­£çš„BiFPNå…³é”®ï¼šå¤šè½®åŒå‘èåˆï¼

  # ç¬¬äºŒæ¬¡ Top-down
  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]  # 23: P5 -> ä¸Šé‡‡æ ·
  - [[-1, 19], 1, Concat, [1]]  # 24: ä¸ç¬¬ä¸€è½®çš„ P4 è¿æ¥
  - [-1, 2, C2f, [512]]  # 25: ç¬¬ä¸‰æ¬¡èåˆ P4ï¼ˆå¢å¼ºï¼‰

  - [-1, 1, nn.Upsample, [None, 2, 'nearest']]  # 26: P4 -> ä¸Šé‡‡æ ·
  - [[-1, 16], 1, Concat, [1]]  # 27: ä¸ç¬¬ä¸€è½®çš„ P3 è¿æ¥
  - [-1, 2, C2f, [256]]  # 28: ç¬¬ä¸‰æ¬¡èåˆ P3ï¼ˆå¢å¼ºï¼‰â­ è¾“å‡ºå±‚ P3_out

  # ç¬¬äºŒæ¬¡ Bottom-up
  - [-1, 1, Conv, [256, 3, 2]]  # 29: P3 -> ä¸‹é‡‡æ ·
  - [[-1, 25], 1, Concat, [1]]  # 30: ä¸ç¬¬äºŒè½®çš„ P4 è¿æ¥
  - [-1, 2, C2f, [512]]  # 31: ç¬¬å››æ¬¡èåˆ P4ï¼ˆæœ€ç»ˆï¼‰â­ è¾“å‡ºå±‚ P4_out

  - [-1, 1, Conv, [512, 3, 2]]  # 32: P4 -> ä¸‹é‡‡æ ·
  - [[-1, 22], 1, Concat, [1]]  # 33: ä¸ç¬¬ä¸€è½®çš„ P5 è¿æ¥
  - [-1, 2, C2f, [1024]]  # 34: ç¬¬å››æ¬¡èåˆ P5ï¼ˆæœ€ç»ˆï¼‰â­ è¾“å‡ºå±‚ P5_out

  # Detect head (ä½¿ç”¨æœ€ç»ˆçš„ä¸‰ä¸ªè¾“å‡ºå±‚)
  - [[28, 31, 34], 1, Detect, [nc]]  # 35: Detect(P3_out, P4_out, P5_out)

# å…³é”®è¯´æ˜ï¼š
# 1. SimAMåœ¨layer 10ï¼Œå¯¹Backboneè¾“å‡ºç‰¹å¾å¢å¼º
# 2. BiFPNé€šè¿‡ä¸¤è½®åŒå‘èåˆå®ç°ï¼š
#    - ç¬¬ä¸€è½®ï¼šlayers 11-22ï¼ˆæ ‡å‡†åŒå‘ï¼‰
#    - ç¬¬äºŒè½®ï¼šlayers 23-34ï¼ˆå¢å¼ºåŒå‘ï¼‰
# 3. æœ€ç»ˆè¾“å‡ºï¼šP3_out(28), P4_out(31), P5_out(34)
# 4. QFLé€šè¿‡è®­ç»ƒæ—¶è®¾ç½® use_qfl=True å¯ç”¨
# 5. å‚æ•°é‡ä¼šæ¯”Baselineå¢åŠ çº¦15-20%ï¼Œè¿™æ˜¯æ­£å¸¸çš„ï¼